<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kanban Board</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1e293b">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Kanban">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
/* â”€â”€ Theme variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bg:       #0f172a;
  --surface:  #1e293b;
  --surface2: #0f172a;
  --border:   #334155;
  --border2:  #475569;
  --text:     #e2e8f0;
  --text2:    #94a3b8;
  --muted:    #64748b;
  --accent:   #3b82f6;
  --accent-bg:#1e3a5f;
  --shadow:   rgba(0,0,0,.45);
  --todo-c:   #94a3b8;
  --prog-c:   #3b82f6;
  --done-c:   #22c55e;
  --p-high:   #ef4444;
  --p-med:    #f59e0b;
  --p-low:    #22c55e;
}
[data-theme="light"] {
  --bg:       #f1f5f9;
  --surface:  #ffffff;
  --surface2: #f8fafc;
  --border:   #e2e8f0;
  --border2:  #cbd5e1;
  --text:     #1e293b;
  --text2:    #475569;
  --muted:    #94a3b8;
  --accent:   #2563eb;
  --accent-bg:#dbeafe;
  --shadow:   rgba(0,0,0,.12);
  --todo-c:   #64748b;
  --prog-c:   #2563eb;
  --done-c:   #16a34a;
}

/* â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  background:var(--bg);color:var(--text);min-height:100vh;
  display:flex;transition:background .2s,color .2s;}

/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar{
  width:220px;height:100vh;background:var(--surface);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;padding:20px 12px;
  flex-shrink:0;transition:background .2s,border-color .2s;
  overflow-y:auto;
}
.sidebar-logo{
  font-size:1rem;font-weight:700;color:var(--text);
  padding:4px 8px;margin-bottom:20px;
  display:flex;align-items:center;gap:8px;
}
.sidebar-logo svg{flex-shrink:0;}
.sidebar-section{font-size:.7rem;font-weight:600;text-transform:uppercase;
  letter-spacing:.8px;color:var(--muted);padding:0 8px;margin-bottom:8px;}
.board-list{display:flex;flex-direction:column;gap:2px;max-height:160px;overflow-y:auto;}
.board-item{
  padding:8px 10px;border-radius:8px;cursor:pointer;
  font-size:.85rem;color:var(--text2);
  display:flex;align-items:center;gap:8px;
  border:1px solid transparent;transition:all .15s;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.board-item:hover{background:var(--surface2);color:var(--text);}
.board-item.active{background:var(--accent-bg);color:var(--accent);border-color:var(--accent);}
.board-item .bi-dot{width:8px;height:8px;border-radius:50%;background:currentColor;flex-shrink:0;}
.board-item-actions{margin-left:auto;display:none;gap:4px;}
.board-item:hover .board-item-actions{display:flex;}
.board-item-actions button{
  background:none;border:none;cursor:pointer;color:var(--muted);
  font-size:.75rem;padding:1px 3px;border-radius:4px;
}
.board-item-actions button:hover{color:var(--p-high);}
.add-board-btn{
  margin-top:8px;padding:8px 10px;border-radius:8px;
  background:none;border:1px dashed var(--border2);
  color:var(--muted);font-size:.82rem;cursor:pointer;
  width:100%;text-align:left;transition:all .15s;
}
.add-board-btn:hover{border-color:var(--accent);color:var(--accent);}
.sidebar-footer{margin-top:auto;padding-top:12px;border-top:1px solid var(--border);}

/* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main{flex:1;display:flex;flex-direction:column;min-width:0;overflow-x:auto;}

/* â”€â”€ Top bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.topbar{
  display:flex;align-items:center;gap:12px;
  padding:16px 24px;border-bottom:1px solid var(--border);
  background:var(--surface);flex-shrink:0;
  transition:background .2s,border-color .2s;
}
.topbar-title{font-size:1.1rem;font-weight:700;white-space:nowrap;}
.search-wrap{flex:1;max-width:320px;position:relative;}
.search-wrap svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted);}
.search-input{
  width:100%;background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;color:var(--text);font-size:.85rem;
  padding:7px 10px 7px 32px;outline:none;transition:border-color .15s;
}
.search-input:focus{border-color:var(--accent);}
.search-input::placeholder{color:var(--muted);}
.filter-tags-wrap{display:flex;gap:6px;flex-wrap:wrap;align-items:center;}
.filter-pill{
  padding:3px 10px;border-radius:99px;font-size:.75rem;font-weight:500;
  border:1px solid var(--border2);background:none;color:var(--text2);
  cursor:pointer;transition:all .15s;white-space:nowrap;
}
.filter-pill:hover{border-color:var(--accent);color:var(--accent);}
.filter-pill.active{background:var(--accent);border-color:var(--accent);color:#fff;}
.topbar-actions{display:flex;gap:8px;margin-left:auto;flex-shrink:0;}
.icon-btn{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;padding:7px 8px;cursor:pointer;color:var(--text2);
  display:flex;align-items:center;gap:5px;font-size:.8rem;
  transition:all .15s;
}
.icon-btn:hover{border-color:var(--border2);color:var(--text);}

/* â”€â”€ Stats bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.statsbar{
  display:flex;align-items:center;gap:24px;
  padding:10px 24px;background:var(--surface);
  border-bottom:1px solid var(--border);font-size:.8rem;flex-shrink:0;
  transition:background .2s;
}
.stat{display:flex;align-items:center;gap:6px;color:var(--text2);}
.stat strong{color:var(--text);}
.progress-track{
  flex:1;max-width:200px;height:6px;background:var(--border);
  border-radius:99px;overflow:hidden;
}
.progress-fill{height:100%;background:var(--done-c);border-radius:99px;transition:width .4s;}

/* â”€â”€ Board â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.board-wrap{flex:1;padding:24px;overflow-x:auto;}
.board{display:flex;gap:20px;align-items:flex-start;min-width:640px;}
.column{
  flex:1;min-width:260px;background:var(--surface);
  border-radius:14px;padding:14px;border:1px solid var(--border);
  transition:background .2s,border-color .2s;
}
.column-header{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:12px;
}
.column-title{
  display:flex;align-items:center;gap:7px;
  font-weight:600;font-size:.82rem;
  text-transform:uppercase;letter-spacing:.8px;
}
.col-dot{width:9px;height:9px;border-radius:50%;}
.col-todo .col-dot,.col-todo .column-title{color:var(--todo-c);}
.col-todo .col-dot{background:var(--todo-c);}
.col-progress .col-dot,.col-progress .column-title{color:var(--prog-c);}
.col-progress .col-dot{background:var(--prog-c);}
.col-done .col-dot,.col-done .column-title{color:var(--done-c);}
.col-done .col-dot{background:var(--done-c);}
.count-badge{
  background:var(--surface2);color:var(--muted);
  font-size:.72rem;font-weight:600;padding:2px 8px;border-radius:99px;
  border:1px solid var(--border);
}

/* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cards{display:flex;flex-direction:column;gap:8px;min-height:48px;}
.cards.drag-over{
  outline:2px dashed var(--accent);outline-offset:4px;border-radius:8px;
}
.card{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:10px;padding:11px 13px;cursor:grab;
  transition:box-shadow .15s,border-color .15s,transform .15s,opacity .15s;
  position:relative;
}
.card:hover{border-color:var(--border2);box-shadow:0 4px 16px var(--shadow);}
.card.dragging{opacity:.35;cursor:grabbing;transform:scale(.97);}
.card.drop-above{box-shadow:0 -3px 0 0 var(--accent)!important;}
.card.drop-below{box-shadow:0 3px 0 0 var(--accent)!important;}
.card.moving{animation:card-pop .25s ease;}
@keyframes card-pop{0%{transform:scale(1.03)}100%{transform:scale(1)}}

.card-top{display:flex;align-items:flex-start;justify-content:space-between;gap:6px;margin-bottom:4px;}
.card-title{font-size:.875rem;line-height:1.45;color:var(--text);flex:1;word-break:break-word;}
.priority-badge{
  flex-shrink:0;font-size:.65rem;font-weight:700;
  padding:2px 7px;border-radius:99px;text-transform:uppercase;letter-spacing:.5px;
}
.p-high{background:#ef444422;color:var(--p-high);border:1px solid #ef444444;}
.p-med {background:#f59e0b22;color:var(--p-med); border:1px solid #f59e0b44;}
.p-low {background:#22c55e22;color:var(--p-low); border:1px solid #22c55e44;}

.card-desc{font-size:.78rem;color:var(--muted);margin-top:4px;line-height:1.5;word-break:break-word;}
.card-desc.collapsed{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
.desc-toggle{background:none;border:none;color:var(--accent);font-size:.72rem;cursor:pointer;padding:2px 0;margin-top:1px;display:block;}
.desc-toggle:hover{text-decoration:underline;}

.card-meta{display:flex;align-items:center;flex-wrap:wrap;gap:5px;margin-top:8px;}
.tag-pill{
  font-size:.68rem;font-weight:500;padding:2px 7px;
  border-radius:99px;border:1px solid transparent;white-space:nowrap;
}
.due-label{
  font-size:.72rem;padding:2px 7px;border-radius:6px;
  font-weight:500;display:flex;align-items:center;gap:3px;
  background:var(--surface);border:1px solid var(--border);color:var(--text2);
}
.due-label.overdue{background:#ef444422;border-color:#ef444444;color:var(--p-high);}
.due-label.today{background:#f59e0b22;border-color:#f59e0b44;color:var(--p-med);}
.due-label.soon{background:#3b82f622;border-color:#3b82f644;color:var(--accent);}

.card-actions{
  display:flex;align-items:center;justify-content:space-between;
  margin-top:9px;gap:5px;
}
.move-btns{display:flex;gap:3px;}
.btn{border:none;border-radius:6px;cursor:pointer;font-size:.72rem;font-weight:500;padding:4px 9px;transition:all .15s;}
.btn-move{background:var(--surface);color:var(--text2);border:1px solid var(--border);}
.btn-move:hover{background:var(--border);color:var(--text);}
.btn-move:disabled{opacity:.25;cursor:default;}
.btn-icon{background:none;border:1px solid transparent;color:var(--muted);padding:4px 7px;}
.btn-icon:hover.edit{color:var(--accent);border-color:var(--accent);background:var(--accent-bg);}
.btn-icon:hover.del{color:var(--p-high);border-color:#ef444455;background:#ef444415;}

.add-card-btn{
  width:100%;margin-top:10px;padding:8px;background:none;
  border:1px dashed var(--border2);border-radius:8px;color:var(--muted);
  font-size:.82rem;cursor:pointer;transition:all .15s;
}
.add-card-btn:hover{border-color:var(--accent);color:var(--accent);}

/* â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);
  backdrop-filter:blur(4px);z-index:200;align-items:center;justify-content:center;
}
.overlay.open{display:flex;}
.modal{
  background:var(--surface);border:1px solid var(--border2);
  border-radius:16px;padding:26px;width:440px;max-width:calc(100vw - 32px);
  box-shadow:0 25px 60px var(--shadow);
  transition:background .2s;
}
.modal h2{font-size:1rem;font-weight:700;margin-bottom:18px;color:var(--text);}
.field{display:flex;flex-direction:column;gap:5px;}
.field label{font-size:.73rem;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text2);}
.field input,.field textarea,.field select{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;color:var(--text);font-size:.88rem;
  padding:9px 11px;outline:none;font-family:inherit;transition:border-color .15s;
}
.field input:focus,.field textarea:focus,.field select:focus{border-color:var(--accent);}
.field textarea{resize:vertical;min-height:72px;}
.field select option{background:var(--surface);}
.modal-row{display:flex;gap:12px;}
.modal-row .field{flex:1;}
.modal-fields{display:flex;flex-direction:column;gap:14px;}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:20px;}
.btn-primary{
  background:var(--accent);color:#fff;padding:8px 20px;
  border-radius:8px;border:none;cursor:pointer;font-size:.85rem;
  font-weight:600;transition:filter .15s;
}
.btn-primary:hover{filter:brightness(1.1);}
.btn-cancel{
  background:var(--surface2);color:var(--text2);padding:8px 16px;
  border-radius:8px;border:1px solid var(--border);cursor:pointer;
  font-size:.85rem;font-weight:500;transition:all .15s;
}
.btn-cancel:hover{border-color:var(--border2);color:var(--text);}

/* â”€â”€ Attachments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.attach-drop{
  border:2px dashed var(--border2);border-radius:8px;
  padding:16px;text-align:center;cursor:pointer;
  transition:all .15s;color:var(--muted);font-size:.82rem;
}
.attach-drop:hover,.attach-drop.dragover{
  border-color:var(--accent);color:var(--accent);background:var(--accent-bg);
}
.attach-drop svg{display:block;margin:0 auto 6px;}
.attach-hint{display:block;font-size:.7rem;color:var(--muted);margin-top:3px;}
.attach-list{display:flex;flex-direction:column;gap:6px;margin-top:8px;}
.attach-item{
  display:flex;align-items:center;gap:8px;
  background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;padding:7px 10px;
}
.attach-thumb{
  width:36px;height:36px;object-fit:cover;border-radius:5px;
  flex-shrink:0;border:1px solid var(--border);
}
.attach-icon{
  width:36px;height:36px;border-radius:5px;background:var(--border);
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;font-size:1rem;
}
.attach-info{flex:1;min-width:0;}
.attach-name{font-size:.78rem;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.attach-size{font-size:.7rem;color:var(--muted);}
.attach-actions{display:flex;gap:4px;flex-shrink:0;}
.attach-btn{
  background:none;border:1px solid transparent;border-radius:6px;
  padding:3px 7px;cursor:pointer;font-size:.72rem;color:var(--muted);transition:all .15s;
}
.attach-btn:hover.dl{color:var(--accent);border-color:var(--accent);}
.attach-btn:hover.rm{color:var(--p-high);border-color:#ef444455;}
/* Card attachment badge */
.attach-badge{
  display:inline-flex;align-items:center;gap:3px;
  font-size:.68rem;color:var(--muted);padding:2px 7px;
  border-radius:6px;background:var(--surface);border:1px solid var(--border);
}
/* â”€â”€ Email attachment display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.email-item{flex-direction:column;align-items:stretch;cursor:default;}
.email-header-row{display:flex;align-items:flex-start;gap:8px;}
.email-icon{font-size:1.2rem;flex-shrink:0;line-height:1.6;}
.email-meta{flex:1;min-width:0;}
.email-subject{font-size:.82rem;font-weight:600;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.email-from{font-size:.7rem;color:var(--muted);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.email-body-wrap{
  margin-top:8px;font-size:.75rem;color:var(--text2);line-height:1.55;
  background:var(--bg);border:1px solid var(--border);border-radius:6px;
  padding:8px 10px;max-height:140px;overflow-y:auto;
  white-space:pre-wrap;word-break:break-word;display:none;
}
.email-body-wrap.open{display:block;}
.email-toggle{
  background:none;border:1px solid var(--border2);border-radius:6px;
  padding:2px 8px;font-size:.7rem;color:var(--muted);cursor:pointer;
  white-space:nowrap;transition:all .15s;flex-shrink:0;
}
.email-toggle:hover{border-color:var(--accent);color:var(--accent);}
/* Card file-drop highlight */
.card.file-drag-over{
  border-color:var(--accent)!important;
  box-shadow:0 0 0 2px var(--accent)44!important;
}

/* Image lightbox */
.lightbox{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);
  z-index:400;align-items:center;justify-content:center;cursor:zoom-out;
}
.lightbox.open{display:flex;}
.lightbox img{max-width:90vw;max-height:90vh;border-radius:10px;box-shadow:0 20px 60px rgba(0,0,0,.8);}

/* Tags input */
.tags-input-wrap{
  display:flex;flex-wrap:wrap;gap:5px;align-items:center;
  background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;padding:6px 8px;cursor:text;min-height:40px;
  transition:border-color .15s;
}
.tags-input-wrap:focus-within{border-color:var(--accent);}
.tag-chip{
  display:flex;align-items:center;gap:4px;
  font-size:.72rem;font-weight:500;padding:2px 8px;
  border-radius:99px;border:1px solid transparent;
}
.tag-chip button{background:none;border:none;cursor:pointer;color:inherit;opacity:.7;font-size:.8rem;padding:0 1px;line-height:1;}
.tag-chip button:hover{opacity:1;}
.tags-input-wrap input{
  border:none;background:none;outline:none;color:var(--text);
  font-size:.82rem;flex:1;min-width:80px;padding:0;
}

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast{
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);
  background:var(--surface);border:1px solid var(--border2);
  border-radius:10px;padding:10px 16px;display:flex;align-items:center;gap:10px;
  box-shadow:0 8px 32px var(--shadow);font-size:.85rem;color:var(--text);
  z-index:300;transition:transform .3s;white-space:nowrap;
}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast-undo{
  background:var(--accent);color:#fff;border:none;border-radius:6px;
  padding:4px 12px;cursor:pointer;font-size:.8rem;font-weight:600;
}

/* â”€â”€ Board name inline edit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.board-name-edit{
  background:none;border:none;border-bottom:2px solid var(--accent);
  color:var(--text);font-size:1.1rem;font-weight:700;outline:none;width:160px;
}

/* â”€â”€ Focus view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.focus-view{
  position:fixed;inset:0;background:var(--bg);z-index:150;
  display:none;flex-direction:column;overflow:hidden;
}
.focus-view.open{display:flex;}
.focus-header{
  display:flex;align-items:center;gap:12px;
  padding:14px 24px;background:var(--surface);
  border-bottom:1px solid var(--border);flex-shrink:0;
}
.focus-back{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;padding:6px 12px;cursor:pointer;
  color:var(--text2);font-size:.85rem;transition:all .15s;
  display:flex;align-items:center;gap:6px;
}
.focus-back:hover{border-color:var(--border2);color:var(--text);}
.focus-title{font-size:1rem;font-weight:700;flex:1;}
.focus-grid{
  flex:1;overflow-y:auto;padding:24px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:14px;align-content:start;align-items:start;
}
.focus-grid .card{cursor:default;}
.expand-btn{
  background:none;border:none;cursor:pointer;color:var(--muted);
  padding:2px 4px;border-radius:4px;font-size:.85rem;
  transition:color .15s;line-height:1;
}
.expand-btn:hover{color:var(--text);}

/* â”€â”€ Widget bottom sheet (mobile) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.widget-sheet-overlay{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:240;
}
.widget-sheet-overlay.open{display:block;}
.widget-sheet{
  position:fixed;bottom:0;left:0;right:0;
  background:var(--surface);border-top:1px solid var(--border2);
  border-radius:16px 16px 0 0;padding:16px;z-index:250;
  max-height:80vh;overflow-y:auto;
  transform:translateY(100%);transition:transform .3s ease;
}
.widget-sheet.open{transform:translateY(0);}
.widget-sheet-title{
  font-size:.9rem;font-weight:700;margin-bottom:12px;
  display:flex;justify-content:space-between;align-items:center;
}
.widget-mobile-btn{display:none;}
@media(max-width:700px){.widget-mobile-btn{display:flex;}}

/* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-col{
  text-align:center;padding:20px 10px;color:var(--muted);font-size:.8rem;
}

/* â”€â”€ Sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sync-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;transition:background .3s;}
.sync-dot.off    {background:var(--muted);}
.sync-dot.syncing{background:var(--p-med);animation:sync-pulse 1s infinite;}
.sync-dot.synced {background:var(--done-c);}
.sync-dot.error  {background:var(--p-high);}
@keyframes sync-pulse{0%,100%{opacity:1}50%{opacity:.35}}
.sync-msg{font-size:.72rem;color:var(--muted);min-height:18px;margin-top:4px;}
.sync-msg.err{color:var(--p-high);}
.sync-msg.ok {color:var(--done-c);}
.sync-note{font-size:.75rem;color:var(--muted);line-height:1.5;margin-bottom:4px;}
.sync-note a{color:var(--accent);}
.bin-id-box{
  margin-top:10px;padding:10px 12px;background:var(--surface2);
  border:1px solid var(--border);border-radius:8px;
  font-size:.75rem;color:var(--text2);word-break:break-all;
}
.bin-id-box strong{display:block;font-size:.7rem;color:var(--muted);margin-bottom:3px;text-transform:uppercase;letter-spacing:.5px;}

/* â”€â”€ Widgets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.widget-section{margin-top:12px;padding-top:12px;border-top:1px solid var(--border);}
.widget-section-header{
  display:flex;align-items:center;justify-content:space-between;
  font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.8px;
  color:var(--muted);padding:0 2px;margin-bottom:8px;cursor:pointer;user-select:none;
}
.widget-section-header:hover{color:var(--text2);}
.widget-panel{display:flex;flex-direction:column;gap:6px;}
.widget-card{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;padding:8px 10px;font-size:.72rem;
}
.widget-title{
  font-size:.65rem;font-weight:600;text-transform:uppercase;
  letter-spacing:.6px;color:var(--muted);margin-bottom:5px;
}
.widget-row{
  display:flex;align-items:center;justify-content:space-between;
  color:var(--text2);padding:1px 0;gap:4px;
}
.widget-val{font-weight:600;color:var(--text);white-space:nowrap;}
.widget-up  {color:var(--done-c);}
.widget-down{color:var(--p-high);}
.widget-muted{color:var(--muted);}

/* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:99px;}

@media(max-width:700px){
  .sidebar{display:none;}
  .board{flex-direction:column;min-width:0;}
  .board-wrap{padding:12px;}
  .column{min-width:0;}
  .statsbar{flex-wrap:wrap;gap:10px;padding:8px 12px;}
  .topbar{padding:10px 12px;gap:8px;flex-wrap:wrap;}
  .search-wrap{max-width:100%;flex:1 1 100%;order:3;}
  .filter-tags-wrap{display:none;}
  .topbar-actions{margin-left:auto;}
  .modal{padding:18px;}
  .modal-row{flex-direction:column;gap:8px;}
  .focus-grid{padding:12px;grid-template-columns:1fr;}
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<nav class="sidebar">
  <div class="sidebar-logo">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><rect x="3" y="3" width="7" height="18" rx="2"/><rect x="14" y="3" width="7" height="11" rx="2"/><rect x="14" y="17" width="7" height="4" rx="2"/></svg>
    Kanban
  </div>
  <div class="sidebar-section">Boards</div>
  <div class="board-list" id="board-list"></div>
  <button class="add-board-btn" onclick="addBoard()">+ New board</button>
  <!-- WIDGETS -->
  <div class="widget-section">
    <div class="widget-section-header" onclick="toggleWidgets()">
      Live Data <span id="widget-toggle-icon">â–²</span>
    </div>
    <div class="widget-panel" id="widget-panel">
      <div class="widget-card" id="w-weather">
        <div class="widget-title">ğŸŒ¤ Weather</div>
        <div class="widget-body widget-muted">Loadingâ€¦</div>
      </div>
      <div class="widget-card" id="w-fx">
        <div class="widget-title">ğŸ’± vs GBP</div>
        <div class="widget-body widget-muted">Loadingâ€¦</div>
      </div>
      <div class="widget-card" id="w-stocks">
        <div class="widget-title">ğŸ“ˆ Markets</div>
        <div class="widget-body widget-muted">Loadingâ€¦</div>
      </div>
      <div class="widget-card" id="w-clocks">
        <div class="widget-title">ğŸ• World Clocks</div>
        <div class="widget-body widget-muted">Loadingâ€¦</div>
      </div>
      <div class="widget-card" id="w-crypto">
        <div class="widget-title">â‚¿ Crypto (GBP)</div>
        <div class="widget-body widget-muted">Loadingâ€¦</div>
      </div>
    </div>
  </div>

  <div class="sidebar-footer">
    <button class="icon-btn" style="width:100%;justify-content:center;margin-bottom:6px" onclick="openSyncModal()">
      <span class="sync-dot off" id="sync-dot"></span>
      Cloud sync
    </button>
    <button class="icon-btn" style="width:100%;justify-content:center;margin-bottom:6px" onclick="openStorageModal()">
      <span class="sync-dot off" id="storage-dot"></span>
      File storage
    </button>
    <button class="icon-btn" style="width:100%;justify-content:center" onclick="toggleTheme()" id="theme-btn">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      Toggle theme
    </button>
  </div>
</nav>

<!-- MAIN -->
<div class="main">
  <!-- Top bar -->
  <div class="topbar">
    <span class="topbar-title" id="topbar-title">Board</span>
    <div class="search-wrap">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input class="search-input" id="search-input" placeholder="Search tasksâ€¦" oninput="renderBoard()">
    </div>
    <div class="filter-tags-wrap" id="priority-filters">
      <button class="filter-pill active" data-pri="all"   onclick="setPriFilter('all')">All</button>
      <button class="filter-pill"        data-pri="high"  onclick="setPriFilter('high')">High</button>
      <button class="filter-pill"        data-pri="med"   onclick="setPriFilter('med')">Med</button>
      <button class="filter-pill"        data-pri="low"   onclick="setPriFilter('low')">Low</button>
      <button class="filter-pill"        data-pri="none"  onclick="setPriFilter('none')">None</button>
    </div>
    <div class="topbar-actions">
      <button class="icon-btn widget-mobile-btn" onclick="openWidgetSheet()">ğŸ“Š Live</button>
      <button class="icon-btn" id="sort-toggle-btn" onclick="toggleSortMode()" title="Switch sort mode">â‡… Priority</button>
      <button class="icon-btn" onclick="openModal(activeCol())">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add task
      </button>
    </div>
  </div>

  <!-- Stats bar -->
  <div class="statsbar" id="statsbar"></div>

  <!-- Board -->
  <div class="board-wrap">
    <div class="board">
      <div class="column col-todo" data-col="todo">
        <div class="column-header">
          <div class="column-title"><span class="col-dot"></span>To Do</div>
          <span class="count-badge" id="count-todo">0</span>
          <button class="expand-btn" onclick="openFocus('todo')" title="Expand view">â¤¢</button>
        </div>
        <div class="cards" id="cards-todo"></div>
        <button class="add-card-btn" onclick="openModal('todo')">+ Add task</button>
      </div>
      <div class="column col-progress" data-col="progress">
        <div class="column-header">
          <div class="column-title"><span class="col-dot"></span>In Progress</div>
          <span class="count-badge" id="count-progress">0</span>
          <button class="expand-btn" onclick="openFocus('progress')" title="Expand view">â¤¢</button>
        </div>
        <div class="cards" id="cards-progress"></div>
        <button class="add-card-btn" onclick="openModal('progress')">+ Add task</button>
      </div>
      <div class="column col-done" data-col="done">
        <div class="column-header">
          <div class="column-title"><span class="col-dot"></span>Completed</div>
          <span class="count-badge" id="count-done">0</span>
          <button class="expand-btn" onclick="openFocus('done')" title="Expand view">â¤¢</button>
        </div>
        <div class="cards" id="cards-done"></div>
        <button class="add-card-btn" onclick="openModal('done')">+ Add task</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="overlay" id="modal-overlay" onclick="onOverlayClick(event)">
  <div class="modal">
    <h2 id="modal-heading">New Task</h2>
    <div class="modal-fields">
      <div class="field"><label>Title</label><input id="m-title" placeholder="What needs to be done?"/></div>
      <div class="field"><label>Description <span style="opacity:.45;font-weight:400">(optional)</span></label><textarea id="m-desc" placeholder="Add more detailâ€¦"></textarea></div>
      <div class="modal-row">
        <div class="field">
          <label>Priority</label>
          <select id="m-priority">
            <option value="none">None</option>
            <option value="low">Low</option>
            <option value="med">Medium</option>
            <option value="high">High</option>
          </select>
        </div>
        <div class="field"><label>Due date</label><input type="date" id="m-due"/></div>
      </div>
      <div class="field">
        <label>Tags</label>
        <div class="tags-input-wrap" id="tags-wrap" onclick="focusTagInput()">
          <input id="m-tag-input" placeholder="Type tag + Enter" onkeydown="tagKeydown(event)">
        </div>
      </div>
      <div class="field">
        <label>Attachments</label>
        <div class="attach-drop" id="attach-drop"
          onclick="document.getElementById('attach-input').click()"
          ondragover="attachDragOver(event)" ondragleave="attachDragLeave(event)" ondrop="attachDrop(event)">
          <input type="file" id="attach-input" multiple style="display:none" onchange="attachFiles(this.files)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
          Click or drag files here
          <span class="attach-hint">ğŸ“§ Outlook email: drag it to your desktop first (saves as .eml), then drag that file here</span>
          <span class="attach-hint">ğŸ’¡ Or: âŒ˜A â†’ âŒ˜C in Outlook, then âŒ˜V anywhere in this window</span>
        </div>
        <div class="attach-list" id="attach-list"></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-primary" id="modal-save-btn" onclick="saveModal()">Add Task</button>
    </div>
  </div>
</div>

<!-- FOCUS VIEW -->
<div class="focus-view" id="focus-view">
  <div class="focus-header">
    <button class="focus-back" onclick="closeFocus()">â† Back</button>
    <span class="focus-title" id="focus-title"></span>
    <span class="count-badge" id="focus-count"></span>
    <button class="icon-btn" onclick="openModal(currentFocusCol)">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add task
    </button>
  </div>
  <div class="focus-grid" id="focus-grid"></div>
</div>

<!-- SYNC MODAL -->
<div class="overlay" id="sync-overlay" onclick="onSyncOverlayClick(event)">
  <div class="modal" style="max-width:400px">
    <h2>â˜ï¸ Cloud Sync</h2>
    <div class="modal-fields">
      <p class="sync-note">
        Sync your board across devices using <a href="https://jsonbin.io" target="_blank">jsonbin.io</a> (free).
        Create a free account, copy your <strong>Master Key</strong>, and paste it below.
      </p>
      <div class="field">
        <label>Master API Key</label>
        <input type="password" id="sync-api-key" placeholder="$2b$10$â€¦" oninput="syncMsg('')"/>
      </div>
      <div class="field">
        <label>Bin ID <span style="opacity:.5;font-weight:400">(leave empty on first device)</span></label>
        <input type="text" id="sync-bin-id" placeholder="Paste Bin ID from another device" oninput="syncMsg('')"/>
      </div>
      <div class="sync-msg" id="sync-msg"></div>
      <div id="sync-bin-display" style="display:none" class="bin-id-box">
        <strong>Your Bin ID â€” paste this on other devices</strong>
        <span id="sync-bin-display-val"></span>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeSyncModal()">Close</button>
      <button class="btn-secondary" id="sync-pull-btn" onclick="manualPull()" style="display:none">â†“ Pull latest</button>
      <button class="btn-primary" id="sync-connect-btn" onclick="syncConnect()">Connect</button>
    </div>
  </div>
</div>

<!-- STORAGE MODAL -->
<div class="overlay" id="storage-overlay" onclick="onStorageOverlayClick(event)">
  <div class="modal" style="max-width:420px">
    <h2>ğŸ—„ï¸ File Storage</h2>
    <div class="modal-fields">
      <p class="sync-note">
        Store attachments in <a href="https://supabase.com" target="_blank">Supabase Storage</a> for cross-device access.
        Create a free account â†’ new project â†’ Storage â†’ bucket named <strong>attachments</strong> (public).
        Then paste your Project URL and anon key from <strong>Project Settings â†’ API</strong>.
      </p>
      <div class="field">
        <label>Project URL</label>
        <input type="text" id="storage-url" placeholder="https://xxxxxxxxxxxx.supabase.co" oninput="storageMsg('')"/>
      </div>
      <div class="field">
        <label>Anon (public) Key</label>
        <input type="password" id="storage-key" placeholder="eyJhbGciOiâ€¦" oninput="storageMsg('')"/>
      </div>
      <div class="sync-msg" id="storage-msg"></div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeStorageModal()">Close</button>
      <button class="btn-primary" id="storage-connect-btn" onclick="storageConnect()">Connect</button>
    </div>
  </div>
</div>

<!-- WIDGET SHEET (mobile) -->
<div class="widget-sheet-overlay" id="widget-sheet-overlay" onclick="closeWidgetSheet()"></div>
<div class="widget-sheet" id="widget-sheet">
  <div class="widget-sheet-title">
    ğŸ“Š Live Data
    <button class="btn-cancel" onclick="closeWidgetSheet()" style="padding:4px 10px;font-size:.8rem">âœ•</button>
  </div>
  <div style="display:flex;flex-direction:column;gap:8px" id="widget-sheet-body"></div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox" onclick="document.getElementById('lightbox').classList.remove('open')">
  <img id="lightbox-img" src="" alt="">
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <span id="toast-msg"></span>
  <button class="toast-undo" id="toast-undo-btn" onclick="undoDelete()">Undo</button>
</div>

<script>
/* â”€â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const COLS = ['todo','progress','done'];
const COL_LABEL = {todo:'To Do', progress:'In Progress', done:'Completed'};
const TAG_COLORS = [
  ['#6366f1','#6366f122'],['#ec4899','#ec489922'],['#14b8a6','#14b8a622'],
  ['#f59e0b','#f59e0b22'],['#8b5cf6','#8b5cf622'],['#06b6d4','#06b6d422'],
  ['#ef4444','#ef444422'],['#22c55e','#22c55e22'],
];

/* â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let state = { boards: [], activeBoardId: null, theme: 'dark' };
let modalCol         = 'todo';
let modalEditId      = null;
let modalTags        = [];
let modalAttachments = []; // { id, name, type, size, data }
let dragId           = null;
let toastTimer  = null;
let undoStack   = null;
let priFilter   = 'all';
let storageConfig        = { url: '', anonKey: '' };
let modalPendingDeletes  = []; // storagePaths to delete from Supabase on save
let sortMode             = 'priority'; // 'priority' or 'manual'

/* â”€â”€â”€ Persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function save() { localStorage.setItem('kanban_v2', JSON.stringify(state)); schedulePush(); }

function load() {
  try { state = JSON.parse(localStorage.getItem('kanban_v2') || 'null') || state; } catch {}
  if (!state.boards || !state.boards.length) {
    const id = uid();
    state = {
      theme: 'dark',
      activeBoardId: id,
      boards: [{
        id, name: 'My Project',
        tasks: [
          { id:uid(), col:'todo',     title:'Design mockups',       desc:'Create wireframes for the new dashboard.',   priority:'high', due:'', tags:['Design'] },
          { id:uid(), col:'todo',     title:'Write unit tests',      desc:'',                                           priority:'med',  due:'', tags:['Dev'] },
          { id:uid(), col:'progress', title:'Implement auth flow',   desc:'OAuth2 + JWT refresh tokens.',               priority:'high', due:'', tags:['Dev','Backend'] },
          { id:uid(), col:'done',     title:'Setup project repo',    desc:'Initialised with README and CI pipeline.',   priority:'low',  due:'', tags:[] },
        ]
      }]
    };
    save();
  }
  document.documentElement.dataset.theme = state.theme || 'dark';
}

function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }

function board() { return state.boards.find(b => b.id === state.activeBoardId) || state.boards[0]; }

/* â”€â”€â”€ Tag colour (stable by name hash) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function tagColor(name) {
  let h = 0;
  for (let i = 0; i < name.length; i++) h = (h * 31 + name.charCodeAt(i)) & 0xffff;
  return TAG_COLORS[h % TAG_COLORS.length];
}

/* â”€â”€â”€ Due date helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function dueClass(due) {
  if (!due) return '';
  const d = new Date(due + 'T00:00:00'), t = new Date();
  t.setHours(0,0,0,0);
  const diff = Math.round((d-t)/86400000);
  if (diff < 0)  return 'overdue';
  if (diff === 0) return 'today';
  if (diff <= 2) return 'soon';
  return '';
}
function fmtDue(due) {
  if (!due) return '';
  const d = new Date(due + 'T00:00:00'), t = new Date();
  t.setHours(0,0,0,0);
  const diff = Math.round((d-t)/86400000);
  if (diff < 0)  return `${Math.abs(diff)}d overdue`;
  if (diff === 0) return 'Due today';
  if (diff === 1) return 'Due tomorrow';
  return 'Due ' + d.toLocaleDateString(undefined,{month:'short',day:'numeric'});
}

/* â”€â”€â”€ Render sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderSidebar() {
  const bl = document.getElementById('board-list');
  bl.innerHTML = '';
  state.boards.forEach(b => {
    const div = document.createElement('div');
    div.className = 'board-item' + (b.id === state.activeBoardId ? ' active' : '');
    div.innerHTML = `<span class="bi-dot"></span>
      <span style="flex:1;overflow:hidden;text-overflow:ellipsis">${escHtml(b.name)}</span>
      <span class="board-item-actions">
        <button onclick="renameBoard('${b.id}',event)" title="Rename">âœ</button>
        ${state.boards.length > 1 ? `<button onclick="deleteBoard('${b.id}',event)" title="Delete">âœ•</button>` : ''}
      </span>`;
    div.addEventListener('click', () => switchBoard(b.id));
    bl.appendChild(div);
  });
}

/* â”€â”€â”€ Render stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderStats() {
  const b = board(); if (!b) return;
  const total = b.tasks.length;
  const done  = b.tasks.filter(t => t.col === 'done').length;
  const prog  = b.tasks.filter(t => t.col === 'progress').length;
  const over  = b.tasks.filter(t => t.due && dueClass(t.due) === 'overdue').length;
  const pct   = total ? Math.round(done/total*100) : 0;
  document.getElementById('statsbar').innerHTML = `
    <div class="stat"><strong>${total}</strong> tasks</div>
    <div class="stat"><strong>${prog}</strong> in progress</div>
    <div class="stat"><strong>${done}</strong> completed</div>
    ${over ? `<div class="stat" style="color:var(--p-high)"><strong>${over}</strong> overdue</div>` : ''}
    <div class="stat" style="flex:1">
      <div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div>
      <span>${pct}% done</span>
    </div>`;
}

/* â”€â”€â”€ Render board â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderBoard() {
  const b = board(); if (!b) return;
  const q   = document.getElementById('search-input').value.trim().toLowerCase();
  document.getElementById('topbar-title').textContent = b.name;

  COLS.forEach(col => {
    const PRI_ORDER = { high:0, med:1, low:2, none:3 };
    let tasks = b.tasks.filter(t => t.col === col);
    if (q)             tasks = tasks.filter(t => t.title.toLowerCase().includes(q) || (t.desc||'').toLowerCase().includes(q) || (t.tags||[]).some(tag => tag.toLowerCase().includes(q)));
    if (priFilter !== 'all') tasks = tasks.filter(t => (t.priority||'none') === priFilter);
    if (sortMode === 'priority') tasks.sort((a,b) => PRI_ORDER[a.priority||'none'] - PRI_ORDER[b.priority||'none']);

    document.getElementById(`count-${col}`).textContent = tasks.length;
    const container = document.getElementById(`cards-${col}`);
    container.innerHTML = '';
    if (!tasks.length) {
      container.innerHTML = `<div class="empty-col">${q||priFilter!=='all'?'No matching tasks':'No tasks yet'}</div>`;
    } else {
      tasks.forEach(task => container.appendChild(buildCard(task)));
    }
  });
  renderStats();
}

function render() { renderSidebar(); renderBoard(); if (currentFocusCol) renderFocus(); }

/* â”€â”€â”€ Build card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function buildCard(task) {
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.id = task.id;
  card.draggable = navigator.maxTouchPoints === 0; // touch devices use touch drag instead

  const colIdx = COLS.indexOf(task.col);
  const pri    = task.priority || 'none';
  const priBadge = pri !== 'none'
    ? `<span class="priority-badge p-${pri}">${pri==='med'?'Medium':pri.charAt(0).toUpperCase()+pri.slice(1)}</span>`
    : '';

  const tagsHtml = (task.tags||[]).map(t => {
    const [fg,bg] = tagColor(t);
    return `<span class="tag-pill" style="color:${fg};background:${bg};border-color:${fg}44">${escHtml(t)}</span>`;
  }).join('');

  const dueC = dueClass(task.due);
  const dueHtml = task.due
    ? `<span class="due-label ${dueC}">ğŸ“… ${fmtDue(task.due)}</span>`
    : '';

  const allAttach   = task.attachments || [];
  const emailCount  = allAttach.filter(a => a.type === 'email').length;
  const fileCount   = allAttach.filter(a => a.type !== 'email').length;
  const emailBadge  = emailCount ? `<span class="attach-badge">âœ‰ï¸ ${emailCount}</span>` : '';
  const fileBadge   = fileCount  ? `<span class="attach-badge">ğŸ“ ${fileCount}</span>`  : '';

  const metaHtml = (tagsHtml || dueHtml || emailBadge || fileBadge)
    ? `<div class="card-meta">${tagsHtml}${dueHtml}${emailBadge}${fileBadge}</div>` : '';

  card.innerHTML = `
    <div class="card-top">
      <div class="card-title">${escHtml(task.title)}</div>
      ${priBadge}
    </div>
    ${task.desc ? (() => {
      const long = task.desc.length > 120 || task.desc.split('\n').length > 3;
      const descHtml = escHtml(task.desc).replace(/\n/g, '<br>');
      return `<div class="card-desc${long ? ' collapsed' : ''}">${descHtml}</div>${long ? `<button class="desc-toggle" onclick="toggleDesc(this)">Show more</button>` : ''}`;
    })() : ''}
    ${metaHtml}
    <div class="card-actions">
      <div class="move-btns">
        ${sortMode === 'manual' ? `<button class="btn btn-move" onclick="moveUp('${task.id}')" title="Move up">â†‘</button><button class="btn btn-move" onclick="moveDown('${task.id}')" title="Move down">â†“</button>` : ''}
        <button class="btn btn-move" onclick="moveTask('${task.id}',-1)" ${colIdx===0?'disabled':''}>â†</button>
        <button class="btn btn-move" onclick="moveTask('${task.id}', 1)" ${colIdx===COLS.length-1?'disabled':''}>â†’</button>
      </div>
      <div style="display:flex;gap:3px">
        <button class="btn btn-icon edit" onclick="openModalEdit('${task.id}')" title="Edit">âœ</button>
        <button class="btn btn-icon del"  onclick="deleteTask('${task.id}')"    title="Delete">âœ•</button>
      </div>
    </div>`;

  card.addEventListener('dragstart', e => {
    dragId = task.id; card.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
  });
  card.addEventListener('dragend', () => {
    dragId = null; card.classList.remove('dragging');
    document.querySelectorAll('.cards').forEach(c => c.classList.remove('drag-over'));
    document.querySelectorAll('.drop-above,.drop-below').forEach(c => c.classList.remove('drop-above','drop-below'));
  });
  card.addEventListener('dragover', e => {
    if (!dragId || dragId === task.id) return;
    e.preventDefault(); e.stopPropagation();
    document.querySelectorAll('.drop-above,.drop-below').forEach(c => c.classList.remove('drop-above','drop-below'));
    const before = e.clientY < card.getBoundingClientRect().top + card.offsetHeight / 2;
    card.classList.add(before ? 'drop-above' : 'drop-below');
  });
  card.addEventListener('dragleave', e => {
    if (!card.contains(e.relatedTarget)) card.classList.remove('drop-above','drop-below');
  });
  card.addEventListener('drop', e => {
    e.preventDefault(); e.stopPropagation();
    card.classList.remove('drop-above','drop-below');
    if (!dragId || dragId === task.id) return;
    const b       = board();
    const dragged = b.tasks.find(t => t.id === dragId);
    const target  = b.tasks.find(t => t.id === task.id);
    if (!dragged || !target) return;
    const before  = e.clientY < card.getBoundingClientRect().top + card.offsetHeight / 2;
    const fromIdx = b.tasks.indexOf(dragged);
    b.tasks.splice(fromIdx, 1);
    const toIdx = b.tasks.indexOf(target);
    dragged.col = target.col;
    b.tasks.splice(before ? toIdx : toIdx + 1, 0, dragged);
    if (sortMode !== 'manual') { sortMode = 'manual'; localStorage.setItem('kanban_sort_mode', sortMode); updateSortBtn(); }
    save(); render();
  });

  setupTouchDrag(card, task.id);

  // File / email drop directly onto card
  card.addEventListener('dragover', e => {
    if ([...e.dataTransfer.types].includes('Files')) {
      e.preventDefault(); e.stopPropagation();
      card.classList.add('file-drag-over');
    }
  });
  card.addEventListener('dragleave', e => {
    if (!card.contains(e.relatedTarget)) card.classList.remove('file-drag-over');
  });
  card.addEventListener('drop', e => {
    const files = [...(e.dataTransfer.files||[])];
    if (!files.length) return;
    e.preventDefault(); e.stopPropagation();
    card.classList.remove('file-drag-over');

    files.forEach(file => {
      const isEml = file.name.toLowerCase().endsWith('.eml') || file.type === 'message/rfc822';
      if (isEml) {
        const reader = new FileReader();
        reader.onload = ev => {
          const email = parseEml(ev.target.result);
          const b = board();
          const t = b.tasks.find(x => x.id === task.id);
          if (!t) return;
          if (!t.attachments) t.attachments = [];
          t.attachments.push({ id:uid(), type:'email', name:email.subject||file.name, ...email });
          save(); render();
          showToast(`Email "${(email.subject||file.name).slice(0,32)}" attached`);
        };
        reader.readAsText(file, 'utf-8');
      } else {
        if (supEnabled()) {
          if (file.size > MAX_SUPABASE_BYTES) { showToast(`"${file.name}" exceeds 50 MB limit`); return; }
          const isImage = file.type.startsWith('image/');
          showToast('Uploadingâ€¦');
          (async () => {
            try {
              let blob = file, mimeType = file.type || 'application/octet-stream';
              if (isImage) {
                const reader = new FileReader();
                const dataUrl = await new Promise(r => { reader.onload = ev => r(ev.target.result); reader.readAsDataURL(file); });
                const compressed = await compressImage(dataUrl, 1600, 0.82);
                blob = dataUrlToBlob(compressed); mimeType = 'image/jpeg';
              }
              const result = await uploadToSupabase(blob, file.name, mimeType, task.id);
              const t2 = board().tasks.find(x => x.id === task.id);
              if (!t2) return;
              if (!t2.attachments) t2.attachments = [];
              t2.attachments.push({ id:uid(), type:mimeType, name:file.name, size:blob.size, storageUrl:result.publicUrl, storagePath:result.storagePath });
              save(); render();
              showToast(`"${file.name.slice(0,32)}" uploaded to cloud`);
            } catch(err) { showToast('Upload failed: ' + err.message); }
          })();
        } else {
          if (file.size > MAX_ATTACH_BYTES) { showToast(`"${file.name}" exceeds 2 MB limit`); return; }
          const reader = new FileReader();
          reader.onload = ev => {
            const b = board();
            const t = b.tasks.find(x => x.id === task.id);
            if (!t) return;
            if (!t.attachments) t.attachments = [];
            const isImage = file.type.startsWith('image/');
            if (isImage) {
              compressImage(ev.target.result, 640, 0.6).then(compressed => {
                t.attachments.push({ id:uid(), type:'image/jpeg', name:file.name, size:compressed.length, data:compressed });
                save(); render();
                showToast(`"${file.name.slice(0,32)}" attached`);
              });
            } else {
              t.attachments.push({ id:uid(), type:file.type, name:file.name, size:file.size, data:ev.target.result });
              save(); render();
              showToast(`"${file.name.slice(0,32)}" attached (local only)`);
            }
          };
          reader.readAsDataURL(file);
        }
      }
    });
  });

  return card;
}

/* â”€â”€â”€ Drag-drop zones (desktop only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
if (navigator.maxTouchPoints === 0) {
  document.querySelectorAll('.cards').forEach(zone => {
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
    zone.addEventListener('drop', e => {
      e.preventDefault(); zone.classList.remove('drag-over');
      if (!dragId) return;
      const col  = zone.id.replace('cards-','');
      const b    = board();
      const task = b.tasks.find(t => t.id === dragId);
      if (task && task.col !== col) { task.col = col; save(); render(); }
    });
  });
}

/* â”€â”€â”€ Task actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function moveTask(id, dir) {
  const b = board();
  const task = b.tasks.find(t => t.id === id); if (!task) return;
  const next = COLS[COLS.indexOf(task.col) + dir];
  if (next) {
    task.col = next; save(); render();
    requestAnimationFrame(() => {
      const el = document.querySelector(`.card[data-id="${id}"]`);
      if (el) { el.classList.remove('moving'); void el.offsetWidth; el.classList.add('moving'); }
    });
  }
}

function deleteTask(id) {
  const b = board();
  const idx = b.tasks.findIndex(t => t.id === id); if (idx < 0) return;
  undoStack = { task: {...b.tasks[idx]}, idx };
  b.tasks.splice(idx, 1);
  save(); render();
  showToast(`"${undoStack.task.title.slice(0,28)}" deleted`, true);
}

/* â”€â”€â”€ Undo / Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showToast(msg, canUndo=false) {
  clearTimeout(toastTimer);
  document.getElementById('toast-msg').textContent = msg;
  document.getElementById('toast-undo-btn').style.display = canUndo ? '' : 'none';
  document.getElementById('toast').classList.add('show');
  toastTimer = setTimeout(hideToast, 10000);
}
function hideToast() { document.getElementById('toast').classList.remove('show'); }
function undoDelete() {
  if (!undoStack) return;
  const b = board();
  b.tasks.splice(undoStack.idx, 0, undoStack.task);
  undoStack = null; save(); render(); hideToast();
}

/* â”€â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function activeCol() { return 'todo'; }

function openModal(col) {
  modalCol = col; modalEditId = null; modalTags = []; modalAttachments = []; modalPendingDeletes = [];
  document.getElementById('modal-heading').textContent = 'New Task';
  document.getElementById('modal-save-btn').textContent = 'Add Task';
  document.getElementById('m-title').value = '';
  document.getElementById('m-desc').value  = '';
  document.getElementById('m-priority').value = 'none';
  document.getElementById('m-due').value   = '';
  document.getElementById('attach-input').value = '';
  renderTagChips([]);
  renderAttachList();
  document.getElementById('modal-overlay').classList.add('open');
  setTimeout(() => document.getElementById('m-title').focus(), 40);
}

function openModalEdit(id) {
  const task = board().tasks.find(t => t.id === id); if (!task) return;
  modalEditId = id; modalCol = task.col; modalTags = [...(task.tags||[])];
  modalAttachments = (task.attachments||[]).map(a => ({...a}));
  modalPendingDeletes = [];
  document.getElementById('modal-heading').textContent = 'Edit Task';
  document.getElementById('modal-save-btn').textContent = 'Save Changes';
  document.getElementById('m-title').value = task.title;
  document.getElementById('m-desc').value  = task.desc || '';
  document.getElementById('m-priority').value = task.priority || 'none';
  document.getElementById('m-due').value   = task.due || '';
  document.getElementById('attach-input').value = '';
  renderTagChips(modalTags);
  renderAttachList();
  document.getElementById('modal-overlay').classList.add('open');
  setTimeout(() => document.getElementById('m-title').focus(), 40);
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
  modalEditId = null;
  modalPendingDeletes = []; // user cancelled â€” discard pending deletes
}

function onOverlayClick(e) { if (e.target.id === 'modal-overlay') closeModal(); }

async function saveModal() {
  const title = document.getElementById('m-title').value.trim();
  if (!title) { document.getElementById('m-title').focus(); return; }
  const desc     = document.getElementById('m-desc').value.trim();
  const priority = document.getElementById('m-priority').value;
  const due      = document.getElementById('m-due').value;
  const tags     = [...modalTags];
  const b        = board();
  const taskId   = modalEditId || uid();

  const attachments = [...modalAttachments];

  // Upload pending files to Supabase if configured
  if (supEnabled()) {
    const toUpload = attachments.filter(a => a.pendingUpload && a.data);
    if (toUpload.length) {
      const btn = document.getElementById('modal-save-btn');
      btn.disabled = true; btn.textContent = 'Uploadingâ€¦';
      try {
        for (const a of toUpload) {
          const result = await uploadToSupabase(a.data, a.name, a.type, taskId);
          a.storageUrl  = result.publicUrl;
          a.storagePath = result.storagePath;
          delete a.data;
          delete a.pendingUpload;
        }
      } catch(err) {
        showToast('Upload failed: ' + err.message);
        btn.disabled = false; btn.textContent = modalEditId ? 'Save Changes' : 'Add Task';
        return;
      }
      btn.disabled = false; btn.textContent = modalEditId ? 'Save Changes' : 'Add Task';
    }
    // Delete removed attachments from Supabase
    if (modalPendingDeletes.length) {
      deleteFromSupabase(modalPendingDeletes); // fire and forget
      modalPendingDeletes = [];
    }
  }

  if (modalEditId) {
    const task = b.tasks.find(t => t.id === modalEditId);
    if (task) Object.assign(task, { title, desc, priority, due, tags, attachments });
  } else {
    b.tasks.push({ id: taskId, col:modalCol, title, desc, priority, due, tags, attachments });
  }
  save(); render(); closeModal();
}

/* â”€â”€â”€ Tags input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderTagChips(tags) {
  const wrap = document.getElementById('tags-wrap');
  const inp  = document.getElementById('m-tag-input');
  wrap.innerHTML = '';
  tags.forEach((t, i) => {
    const [fg, bg] = tagColor(t);
    const chip = document.createElement('span');
    chip.className = 'tag-chip';
    chip.style.cssText = `color:${fg};background:${bg};border-color:${fg}66`;
    chip.innerHTML = `${escHtml(t)}<button onclick="removeTag(${i})" tabindex="-1">Ã—</button>`;
    wrap.appendChild(chip);
  });
  wrap.appendChild(inp);
}
function focusTagInput() { document.getElementById('m-tag-input').focus(); }
function removeTag(i) { modalTags.splice(i,1); renderTagChips(modalTags); }
function tagKeydown(e) {
  const inp = e.target;
  if ((e.key === 'Enter' || e.key === ',') && inp.value.trim()) {
    e.preventDefault();
    const tag = inp.value.trim().replace(/,/g,'');
    if (tag && !modalTags.includes(tag)) { modalTags.push(tag); renderTagChips(modalTags); }
    else inp.value = '';
  }
  if (e.key === 'Backspace' && !inp.value && modalTags.length) {
    modalTags.pop(); renderTagChips(modalTags);
  }
}

/* â”€â”€â”€ Attachments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const MAX_ATTACH_BYTES   = 2  * 1024 * 1024; // 2 MB  (local/JSONbin)
const MAX_SUPABASE_BYTES = 50 * 1024 * 1024; // 50 MB (Supabase free tier)

function attachDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'copy';
  document.getElementById('attach-drop').classList.add('dragover');
}
function attachDragLeave(e) {
  if (!document.getElementById('attach-drop').contains(e.relatedTarget))
    document.getElementById('attach-drop').classList.remove('dragover');
}
function attachDrop(e) { e.preventDefault(); attachDragLeave(e); attachFiles(e.dataTransfer.files); }

function attachFiles(files) {
  [...files].forEach(file => {
    const isEml = file.name.toLowerCase().endsWith('.eml') || file.type === 'message/rfc822';
    if (isEml) {
      const reader = new FileReader();
      reader.onload = ev => {
        const email = parseEml(ev.target.result);
        modalAttachments.push({ id:uid(), type:'email', name:email.subject||file.name, ...email });
        renderAttachList();
      };
      reader.readAsText(file, 'utf-8');
      return;
    }
    if (supEnabled() && file.size > MAX_SUPABASE_BYTES) {
      showToast(`"${file.name}" is too large (max 50 MB)`); return;
    }
    if (!supEnabled() && file.size > MAX_ATTACH_BYTES) {
      showToast(`"${file.name}" is too large (max 2 MB)`); return;
    }
    const reader = new FileReader();
    reader.onload = ev => {
      const isImage = file.type.startsWith('image/');
      if (isImage) {
        // Higher quality when Supabase will handle storage; lower when fitting in JSONbin
        const maxW = supEnabled() ? 1600 : 640;
        const q    = supEnabled() ? 0.82 : 0.6;
        compressImage(ev.target.result, maxW, q).then(compressed => {
          modalAttachments.push({
            id:uid(), name:file.name, type:'image/jpeg', size:compressed.length,
            data:compressed, pendingUpload: supEnabled()
          });
          renderAttachList();
        });
      } else {
        modalAttachments.push({
          id:uid(), name:file.name, type:file.type, size:file.size,
          data:ev.target.result, pendingUpload: supEnabled()
        });
        renderAttachList();
      }
    };
    reader.readAsDataURL(file);
  });
}

function compressImage(dataUrl, maxWidth, quality) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      let w = img.width, h = img.height;
      if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      resolve(canvas.toDataURL('image/jpeg', quality));
    };
    img.src = dataUrl;
  });
}

function removeAttachment(id) {
  const a = modalAttachments.find(x => x.id === id);
  if (a && a.storagePath) modalPendingDeletes.push(a.storagePath);
  modalAttachments = modalAttachments.filter(a => a.id !== id);
  renderAttachList();
}

function downloadAttachment(id) {
  const a = modalAttachments.find(x => x.id === id); if (!a) return;
  const link = document.createElement('a');
  link.href = a.storageUrl || a.data;
  link.download = a.name;
  if (a.storageUrl) link.target = '_blank';
  link.click();
}

function fmtBytes(b) {
  if (b < 1024) return b + ' B';
  if (b < 1024*1024) return (b/1024).toFixed(1) + ' KB';
  return (b/(1024*1024)).toFixed(1) + ' MB';
}

function fileEmoji(type) {
  if (type.startsWith('image/'))       return 'ğŸ–¼ï¸';
  if (type === 'application/pdf')       return 'ğŸ“„';
  if (type.includes('word'))            return 'ğŸ“';
  if (type.includes('sheet') || type.includes('excel')) return 'ğŸ“Š';
  if (type.startsWith('video/'))        return 'ğŸ¬';
  if (type.startsWith('audio/'))        return 'ğŸµ';
  if (type.includes('zip') || type.includes('compressed')) return 'ğŸ—œï¸';
  return 'ğŸ“';
}

function renderAttachList() {
  const list = document.getElementById('attach-list');
  list.innerHTML = '';
  modalAttachments.forEach(a => {
    const item = document.createElement('div');

    if (a.type === 'email') {
      const bodyId = 'eb-' + a.id;
      item.className = 'attach-item email-item';
      item.innerHTML = `
        <div class="email-header-row">
          <div class="email-icon">âœ‰ï¸</div>
          <div class="email-meta">
            <div class="email-subject" title="${escHtml(a.subject)}">${escHtml(a.subject||a.name)}</div>
            <div class="email-from">${escHtml(a.from)}${a.date ? ' &middot; ' + escHtml(fmtEmailDate(a.date)) : ''}</div>
          </div>
          <div class="attach-actions">
            ${a.body ? `<button class="email-toggle" onclick="toggleEmailBody('${bodyId}')">Preview</button>` : ''}
            <button class="attach-btn rm" onclick="removeAttachment('${a.id}')" title="Remove">âœ•</button>
          </div>
        </div>
        ${a.body ? `<div class="email-body-wrap" id="${bodyId}">${escHtml(a.body)}</div>` : ''}`;
    } else {
      item.className = 'attach-item';
      const isImg      = (a.type||'').startsWith('image/');
      const imgSrc     = a.storageUrl || (isImg ? a.data : null);
      const unavailable = a.cloudStripped && !a.data && !a.storageUrl;
      const isPending  = a.pendingUpload && !a.storageUrl;
      let sizeLabel;
      if (unavailable) sizeLabel = 'Added on another device â€” not available here';
      else if (isPending) sizeLabel = 'â˜ï¸ Will upload to Supabase on save';
      else if (a.storageUrl) sizeLabel = fmtBytes(a.size||0) + ' Â· cloud';
      else sizeLabel = fmtBytes(a.size||0);
      item.innerHTML = `
        ${imgSrc
          ? `<img class="attach-thumb" src="${imgSrc}" alt="${escHtml(a.name)}" onclick="openLightbox('${a.id}')" style="cursor:zoom-in">`
          : `<div class="attach-icon">${unavailable ? 'ğŸ”’' : fileEmoji(a.type||'')}</div>`}
        <div class="attach-info">
          <div class="attach-name" title="${escHtml(a.name)}">${escHtml(a.name)}</div>
          <div class="attach-size">${sizeLabel}</div>
        </div>
        <div class="attach-actions">
          ${(!unavailable && !isPending) ? `<button class="attach-btn dl" onclick="downloadAttachment('${a.id}')" title="Download">â†“</button>` : ''}
          <button class="attach-btn rm" onclick="removeAttachment('${a.id}')" title="Remove">âœ•</button>
        </div>`;
    }
    list.appendChild(item);
  });
}

function openLightbox(id) {
  const a = modalAttachments.find(x => x.id === id); if (!a) return;
  document.getElementById('lightbox-img').src = a.storageUrl || a.data;
  document.getElementById('lightbox').classList.add('open');
}

/* â”€â”€â”€ EML parser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function parseEml(raw) {
  const text = raw.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  const sep   = text.indexOf('\n\n');
  const hBlock = sep >= 0 ? text.slice(0, sep) : text;
  const bBlock = sep >= 0 ? text.slice(sep + 2) : '';

  function parseHeaders(block) {
    const h = {};
    block.replace(/\n[ \t]+/g, ' ').split('\n').forEach(line => {
      const i = line.indexOf(':');
      if (i > 0) { const k = line.slice(0,i).toLowerCase().trim(); if (!h[k]) h[k] = line.slice(i+1).trim(); }
    });
    return h;
  }

  function decodeWord(s) {
    return (s||'').replace(/=\?([^?]+)\?([BbQq])\?([^?]*)\?=/g, (_,cs,enc,val) => {
      try {
        if (enc.toUpperCase()==='B') {
          const b = atob(val); return new TextDecoder(cs).decode(Uint8Array.from(b,c=>c.charCodeAt(0)));
        }
        return val.replace(/_/g,' ').replace(/=([0-9A-Fa-f]{2})/g,(_,h)=>String.fromCharCode(parseInt(h,16)));
      } catch { return val; }
    });
  }

  function decodeQP(s) {
    return s.replace(/=\n/g,'').replace(/=([0-9A-Fa-f]{2})/g,(_,h)=>String.fromCharCode(parseInt(h,16)));
  }

  function decodeB64(s,cs='utf-8') {
    try { const b=atob(s.replace(/\s/g,'')); return new TextDecoder(cs).decode(Uint8Array.from(b,c=>c.charCodeAt(0))); }
    catch { return s; }
  }

  function stripHtml(html) {
    return html
      .replace(/<style[\s\S]*?<\/style>/gi,'').replace(/<script[\s\S]*?<\/script>/gi,'')
      .replace(/<br\s*\/?>/gi,'\n').replace(/<\/(?:p|div|tr|li)>/gi,'\n')
      .replace(/<[^>]+>/g,'')
      .replace(/&nbsp;/g,' ').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&').replace(/&quot;/g,'"').replace(/&#(\d+);/g,(_,n)=>String.fromCharCode(n))
      .replace(/\n{3,}/g,'\n\n').trim();
  }

  function decodePart(headers, body) {
    const cte = (headers['content-transfer-encoding']||'').toLowerCase().trim();
    const cs   = (headers['content-type']||'').match(/charset="?([^";\s]+)"?/i)?.[1] || 'utf-8';
    if (cte==='base64')            return decodeB64(body, cs);
    if (cte==='quoted-printable')  return decodeQP(body);
    return body;
  }

  function extractParts(body, boundary) {
    const delim = '--' + boundary;
    const parts = body.split(new RegExp('(?:^|\n)' + delim.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + '(?:--)?(?:\n|$)'));
    return parts.slice(1, parts.length-1).map(s => {
      const si = s.indexOf('\n\n');
      if (si < 0) return null;
      return { headers: parseHeaders(s.slice(0,si)), body: s.slice(si+2) };
    }).filter(Boolean);
  }

  function getBodyText(headers, body) {
    const ct  = headers['content-type'] || 'text/plain';
    if (ct.includes('multipart/')) {
      const bm = ct.match(/boundary="?([^";\n]+)"?/i);
      if (!bm) return body.trim();
      const parts = extractParts(body, bm[1].trim());
      let plain=null, html=null;
      for (const p of parts) {
        const pct = p.headers['content-type']||'';
        if (pct.includes('multipart/')) { const nested=getBodyText(p.headers,p.body); if(nested) return nested; }
        if (pct.includes('text/plain') && !plain) plain=p;
        if (pct.includes('text/html')  && !html)  html=p;
      }
      if (plain) return decodePart(plain.headers, plain.body).trim();
      if (html)  return stripHtml(decodePart(html.headers, html.body));
      return '';
    }
    const decoded = decodePart(headers, body);
    return ct.includes('text/html') ? stripHtml(decoded) : decoded.trim();
  }

  const headers = parseHeaders(hBlock);
  return {
    subject: decodeWord(headers['subject'] || '(no subject)'),
    from:    decodeWord(headers['from']    || ''),
    to:      decodeWord(headers['to']      || ''),
    date:    headers['date'] || '',
    body:    getBodyText(headers, bBlock),
  };
}

function fmtEmailDate(s) {
  if (!s) return '';
  try { const d=new Date(s); if(isNaN(d)) return s; return d.toLocaleString(undefined,{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'}); }
  catch { return s; }
}

function toggleDesc(btn) {
  const el = btn.closest('.card').querySelector('.card-desc');
  if (!el) return;
  el.classList.toggle('collapsed');
  btn.textContent = el.classList.contains('collapsed') ? 'Show more' : 'Show less';
}

function toggleEmailBody(id) {
  const el  = document.getElementById(id); if (!el) return;
  const btn = el.previousElementSibling?.querySelector('.email-toggle');
  el.classList.toggle('open');
  if (btn) btn.textContent = el.classList.contains('open') ? 'Hide' : 'Preview';
}

/* â”€â”€â”€ Boards management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function switchBoard(id) { state.activeBoardId = id; save(); render(); }

function addBoard() {
  const name = prompt('Board name:','New Board'); if (!name) return;
  const b = { id:uid(), name:name.trim(), tasks:[] };
  state.boards.push(b); state.activeBoardId = b.id; save(); render();
}

function renameBoard(id, e) {
  e.stopPropagation();
  const b = state.boards.find(x => x.id === id); if (!b) return;
  const name = prompt('Rename board:', b.name); if (!name) return;
  b.name = name.trim(); save(); render();
}

function deleteBoard(id, e) {
  e.stopPropagation();
  if (!confirm('Delete this board and all its tasks?')) return;
  state.boards = state.boards.filter(b => b.id !== id);
  if (state.activeBoardId === id) state.activeBoardId = state.boards[0]?.id;
  save(); render();
}

/* â”€â”€â”€ Focus view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let currentFocusCol = null;

function openFocus(col) {
  currentFocusCol = col;
  renderFocus();
  document.getElementById('focus-view').classList.add('open');
}

function closeFocus() {
  currentFocusCol = null;
  document.getElementById('focus-view').classList.remove('open');
}

function renderFocus() {
  if (!currentFocusCol) return;
  const b = board();
  const PRI_ORDER = { high:0, med:1, low:2, none:3 };
  const q = document.getElementById('search-input').value.trim().toLowerCase();
  let tasks = b.tasks.filter(t => t.col === currentFocusCol);
  if (q) tasks = tasks.filter(t => t.title.toLowerCase().includes(q) || (t.desc||'').toLowerCase().includes(q) || (t.tags||[]).some(tag => tag.toLowerCase().includes(q)));
  if (priFilter !== 'all') tasks = tasks.filter(t => (t.priority||'none') === priFilter);
  if (sortMode === 'priority') tasks.sort((a,b) => PRI_ORDER[a.priority||'none'] - PRI_ORDER[b.priority||'none']);

  document.getElementById('focus-title').textContent = COL_LABEL[currentFocusCol];
  document.getElementById('focus-count').textContent = tasks.length;

  const grid = document.getElementById('focus-grid');
  grid.innerHTML = '';
  if (!tasks.length) {
    grid.innerHTML = '<div class="empty-col" style="grid-column:1/-1">No tasks here</div>';
  } else {
    tasks.forEach(t => grid.appendChild(buildCard(t)));
  }
}

/* â”€â”€â”€ Manual ordering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function moveUp(id) {
  const b = board();
  const task = b.tasks.find(t => t.id === id); if (!task) return;
  const colTasks = b.tasks.map((t,i) => ({t,i})).filter(({t}) => t.col === task.col);
  const pos = colTasks.findIndex(({t}) => t.id === id);
  if (pos === 0) return;
  const curr = colTasks[pos].i, prev = colTasks[pos-1].i;
  [b.tasks[curr], b.tasks[prev]] = [b.tasks[prev], b.tasks[curr]];
  save(); render();
}

function moveDown(id) {
  const b = board();
  const task = b.tasks.find(t => t.id === id); if (!task) return;
  const colTasks = b.tasks.map((t,i) => ({t,i})).filter(({t}) => t.col === task.col);
  const pos = colTasks.findIndex(({t}) => t.id === id);
  if (pos === colTasks.length - 1) return;
  const curr = colTasks[pos].i, next = colTasks[pos+1].i;
  [b.tasks[curr], b.tasks[next]] = [b.tasks[next], b.tasks[curr]];
  save(); render();
}

/* â”€â”€â”€ Touch drag-to-reorder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let tdState = null;
let tdGhost = null;

function setupTouchDrag(card, taskId) {
  card.addEventListener('touchstart', e => {
    if (e.touches.length !== 1) return;
    const t = e.touches[0];
    tdState = {
      card, taskId,
      startX: t.clientX, startY: t.clientY,
      isDragging: false, offX: 0, offY: 0,
      timer: setTimeout(() => tdBeginDrag(t), 350)
    };
  }, { passive: true });

  card.addEventListener('touchmove', e => {
    if (!tdState || tdState.card !== card) return;
    const t = e.touches[0];
    if (!tdState.isDragging) {
      if (Math.hypot(t.clientX - tdState.startX, t.clientY - tdState.startY) > 8) {
        clearTimeout(tdState.timer); tdState = null;
      }
      return;
    }
    e.preventDefault();
    tdMoveGhost(t);
    tdShowIndicator(t);
  }, { passive: false });

  card.addEventListener('touchend', e => {
    if (!tdState || tdState.card !== card) return;
    clearTimeout(tdState.timer);
    if (tdState.isDragging) { tdFinishDrop(e.changedTouches[0]); tdCleanup(); }
    tdState = null;
  });
  card.addEventListener('touchcancel', () => {
    if (!tdState || tdState.card !== card) return;
    clearTimeout(tdState.timer);
    if (tdState.isDragging) tdCleanup();
    tdState = null;
  });
}

function tdBeginDrag(touch) {
  if (!tdState) return;
  tdState.isDragging = true;
  const card = tdState.card;
  const rect = card.getBoundingClientRect();
  tdState.offX = touch.clientX - rect.left;
  tdState.offY = touch.clientY - rect.top;
  tdGhost = card.cloneNode(true);
  Object.assign(tdGhost.style, {
    position:'fixed', width:rect.width+'px',
    left:(touch.clientX - tdState.offX)+'px', top:(touch.clientY - tdState.offY)+'px',
    opacity:'0.88', zIndex:'9999', pointerEvents:'none',
    boxShadow:'0 12px 40px rgba(0,0,0,0.5)',
    transform:'rotate(2deg) scale(1.04)', transition:'none',
    borderRadius: getComputedStyle(card).borderRadius,
  });
  document.body.appendChild(tdGhost);
  card.style.opacity = '0.25';
  if (navigator.vibrate) navigator.vibrate(30);
}

function tdMoveGhost(touch) {
  if (!tdGhost || !tdState) return;
  tdGhost.style.left = (touch.clientX - tdState.offX) + 'px';
  tdGhost.style.top  = (touch.clientY - tdState.offY) + 'px';
}

function tdElAt(x, y) {
  // Hide ghost so it doesn't intercept hit-test
  if (tdGhost) tdGhost.style.visibility = 'hidden';
  const el = document.elementFromPoint(x, y);
  if (tdGhost) tdGhost.style.visibility = '';
  return el;
}

function tdShowIndicator(touch) {
  document.querySelectorAll('.td-indicator').forEach(e => e.remove());
  const el = tdElAt(touch.clientX, touch.clientY);
  const targetCard = el?.closest('.card');
  if (targetCard && tdState && targetCard !== tdState.card) {
    const rect   = targetCard.getBoundingClientRect();
    const before = touch.clientY < rect.top + rect.height / 2;
    const line   = document.createElement('div');
    line.className = 'td-indicator';
    Object.assign(line.style, {
      position:'fixed', left:rect.left+'px',
      top:(before ? rect.top - 3 : rect.bottom + 1)+'px',
      width:rect.width+'px', height:'3px',
      background:'var(--accent)', borderRadius:'2px',
      zIndex:'9998', pointerEvents:'none',
    });
    document.body.appendChild(line);
  }
}

function tdNearestCard(zone, touchY, excludeCard) {
  // If released in the gap between cards, find the closest card by distance
  const cards = [...zone.querySelectorAll('.card')].filter(c => c !== excludeCard);
  let best = null, bestDist = Infinity;
  for (const c of cards) {
    const r    = c.getBoundingClientRect();
    const dist = Math.max(r.top - touchY, touchY - r.bottom, 0); // 0 if inside
    if (dist < bestDist) { bestDist = dist; best = c; }
  }
  return bestDist < 80 ? best : null; // only snap if reasonably close
}

function tdFinishDrop(touch) {
  if (!tdState) return;
  const el   = tdElAt(touch.clientX, touch.clientY);
  const b    = board();
  const task = b.tasks.find(t => t.id === tdState.taskId);
  if (!task) return;

  let targetCard = el?.closest('.card');
  const targetZone = el?.closest('.cards') || tdElAt(touch.clientX, touch.clientY)?.closest('.column');

  // If finger landed in gap between cards, snap to nearest card
  if ((!targetCard || targetCard === tdState.card) && targetZone) {
    const zone = targetZone.classList.contains('cards')
      ? targetZone
      : targetZone.querySelector('.cards');
    if (zone) targetCard = tdNearestCard(zone, touch.clientY, tdState.card);
  }

  if (targetCard && targetCard !== tdState.card) {
    const target = b.tasks.find(t => t.id === targetCard.dataset.id);
    if (!target) return;
    const rect    = targetCard.getBoundingClientRect();
    const before  = touch.clientY < rect.top + rect.height / 2;
    const fromIdx = b.tasks.indexOf(task);
    b.tasks.splice(fromIdx, 1);
    const toIdx = b.tasks.indexOf(target);
    task.col = target.col;
    b.tasks.splice(before ? toIdx : toIdx + 1, 0, task);
    if (sortMode !== 'manual') { sortMode = 'manual'; localStorage.setItem('kanban_sort_mode', sortMode); updateSortBtn(); }
    save(); render();
  } else if (targetZone) {
    const zone = targetZone.classList.contains('cards') ? targetZone : targetZone.querySelector('.cards');
    const col  = zone ? zone.id.replace('cards-', '') : null;
    if (col && task.col !== col) { task.col = col; save(); render(); }
  }
}

function tdCleanup() {
  if (tdGhost) { tdGhost.remove(); tdGhost = null; }
  if (tdState?.card) tdState.card.style.opacity = '';
  document.querySelectorAll('.td-indicator').forEach(e => e.remove());
}

function toggleSortMode() {
  sortMode = sortMode === 'priority' ? 'manual' : 'priority';
  localStorage.setItem('kanban_sort_mode', sortMode);
  updateSortBtn();
  render();
}

function updateSortBtn() {
  const btn = document.getElementById('sort-toggle-btn');
  if (!btn) return;
  if (sortMode === 'manual') {
    btn.textContent = 'â†• Manual';
    btn.style.color = 'var(--accent)';
    btn.style.borderColor = 'var(--accent)';
  } else {
    btn.textContent = 'â‡… Priority';
    btn.style.color = '';
    btn.style.borderColor = '';
  }
}

function loadSortMode() {
  sortMode = localStorage.getItem('kanban_sort_mode') || 'priority';
  updateSortBtn();
}

/* â”€â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleTheme() {
  state.theme = state.theme === 'dark' ? 'light' : 'dark';
  document.documentElement.dataset.theme = state.theme;
  save();
}

/* â”€â”€â”€ Priority filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setPriFilter(pri) {
  priFilter = pri;
  document.querySelectorAll('#priority-filters .filter-pill')
    .forEach(p => p.classList.toggle('active', p.dataset.pri === pri));
  renderBoard();
}

/* â”€â”€â”€ Clipboard paste (email from Outlook) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('paste', e => {
  if (!document.getElementById('modal-overlay').classList.contains('open')) return;
  // Let the user type normally in text fields
  const tag = document.activeElement.tagName;
  if (tag === 'INPUT' || tag === 'TEXTAREA') return;

  // Pasted files (.eml from Finder copy etc.)
  const files = e.clipboardData?.files;
  if (files?.length) { e.preventDefault(); attachFiles(files); return; }

  const html  = e.clipboardData?.getData('text/html')  || '';
  const plain = e.clipboardData?.getData('text/plain') || '';
  if (!html && !plain) return;

  e.preventDefault();
  const email = parseClipboardEmail(html, plain);
  modalAttachments.push({ id:uid(), type:'email', name:email.subject||'Pasted email', ...email });
  renderAttachList();
  showToast('Email attached from clipboard');
});

function parseClipboardEmail(html, plain) {
  let subject='', from='', to='', date='', body='';
  const lines = plain.split(/\r?\n/);
  let inBody = false;
  const bodyLines = [];

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    if (!inBody) {
      const m = line.match(/^(From|Sent|Date|To|Subject|Cc):\s*(.+)/i);
      if (m) {
        const k = m[1].toLowerCase(), v = m[2].trim();
        if (k==='from')    from    = v;
        if (k==='sent' || k==='date') date = v;
        if (k==='to')      to      = v;
        if (k==='subject') subject = v;
      } else if (line.trim()==='' && (from||subject)) {
        inBody = true;
      } else if (i > 10) {
        inBody = true; bodyLines.push(line);
      }
    } else {
      bodyLines.push(line);
    }
  }

  body = bodyLines.join('\n').trim() || plain.trim();

  // Fallback: try to pull subject from HTML meta if plain text had no headers
  if (!subject && html) {
    const m = html.match(/Subject[^>]*>([^<]{1,120})/i);
    if (m) subject = m[1].trim();
  }

  return { subject: subject||'Pasted email', from, to, date, body };
}

/* â”€â”€â”€ Keyboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeModal(); closeFocus(); }
  if (e.key === 'Enter' && document.getElementById('modal-overlay').classList.contains('open')) {
    if (!['TEXTAREA','SELECT'].includes(document.activeElement.tagName) &&
        document.activeElement.id !== 'm-tag-input') {
      e.preventDefault(); saveModal();
    }
  }
});

/* â”€â”€â”€ Escape HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function escHtml(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* â”€â”€â”€ Cloud Sync (JSONbin.io) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const JSONBIN = 'https://api.jsonbin.io/v3';
let syncConfig = { apiKey:'', binId:'' };
let syncStatus = 'off';
let syncPushTimer = null;

function loadSyncConfig() {
  try { syncConfig = JSON.parse(localStorage.getItem('kanban_sync')||'{}') || {}; } catch {}
  syncConfig.apiKey = syncConfig.apiKey || '';
  syncConfig.binId  = syncConfig.binId  || '';
  updateSyncDot(syncConfig.apiKey && syncConfig.binId ? 'idle' : 'off');
}

function saveSyncConfig() {
  localStorage.setItem('kanban_sync', JSON.stringify(syncConfig));
}

// Sync any attachment whose data is small enough (<60KB). Strip larger ones.
function stateForCloud() {
  const s = JSON.parse(JSON.stringify(state));
  s.boards.forEach(b => b.tasks.forEach(t =>
    (t.attachments||[]).forEach(a => {
      if (!a.data) return; // emails and already-stripped items have no data field
      if (a.data.length > 60000) {
        delete a.data; a.cloudStripped = true;
      } else {
        delete a.localOnly; // small enough to sync, clear the local-only flag
      }
    })
  ));
  return s;
}

// When pulling from cloud, restore any local binary data we already have
function mergeCloudState(cloud) {
  const localData = {};
  (state.boards||[]).forEach(b => (b.tasks||[]).forEach(t =>
    (t.attachments||[]).forEach(a => { if (a.data) localData[`${t.id}:${a.id}`] = a.data; })
  ));
  state = cloud;
  (state.boards||[]).forEach(b => (b.tasks||[]).forEach(t =>
    (t.attachments||[]).forEach(a => { const k=`${t.id}:${a.id}`; if (localData[k]) { a.data=localData[k]; delete a.cloudStripped; } })
  ));
}

function updateSyncDot(status) {
  syncStatus = status;
  const dot = document.getElementById('sync-dot');
  if (dot) dot.className = `sync-dot ${status}`;
}

async function syncPush() {
  if (!syncConfig.apiKey || !syncConfig.binId) return;
  updateSyncDot('syncing');
  try {
    // First attempt: include compressed images
    const payload = stateForCloud();
    let res = await fetch(`${JSONBIN}/b/${syncConfig.binId}`, {
      method: 'PUT',
      headers: { 'Content-Type':'application/json', 'X-Master-Key': syncConfig.apiKey },
      body: JSON.stringify(payload)
    });
    // If payload too large, retry with all binary data stripped
    if (!res.ok && (res.status === 400 || res.status === 413)) {
      const stripped = JSON.parse(JSON.stringify(payload));
      stripped.boards.forEach(b => b.tasks.forEach(t =>
        (t.attachments||[]).forEach(a => { if (a.data) { delete a.data; a.cloudStripped = true; } })
      ));
      res = await fetch(`${JSONBIN}/b/${syncConfig.binId}`, {
        method: 'PUT',
        headers: { 'Content-Type':'application/json', 'X-Master-Key': syncConfig.apiKey },
        body: JSON.stringify(stripped)
      });
      showToast('Photo too large to sync â€” visible on this device only');
    }
    if (!res.ok) throw new Error(res.status);
    updateSyncDot('synced');
    setTimeout(() => updateSyncDot('idle'), 2000);
  } catch { updateSyncDot('error'); }
}

async function syncPull() {
  if (!syncConfig.apiKey || !syncConfig.binId) return;
  updateSyncDot('syncing');
  try {
    const res = await fetch(`${JSONBIN}/b/${syncConfig.binId}/latest`, {
      headers: { 'X-Master-Key': syncConfig.apiKey }
    });
    if (!res.ok) throw new Error(res.status);
    const data = await res.json();
    mergeCloudState(data.record);
    localStorage.setItem('kanban_v2', JSON.stringify(state));
    render();
    updateSyncDot('synced');
    setTimeout(() => updateSyncDot('idle'), 2000);
  } catch { updateSyncDot('error'); }
}

function schedulePush() {
  if (!syncConfig.apiKey || !syncConfig.binId) return;
  clearTimeout(syncPushTimer);
  syncPushTimer = setTimeout(syncPush, 2500);
}

// Sync when tab becomes visible again (e.g. switching from phone back to Mac)
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) syncPull();
});

/* â”€â”€ Sync modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openSyncModal() {
  document.getElementById('sync-api-key').value = syncConfig.apiKey || '';
  document.getElementById('sync-bin-id').value  = syncConfig.binId  || '';
  syncMsg('');
  showBinDisplay(syncConfig.binId);
  document.getElementById('sync-pull-btn').style.display = (syncConfig.apiKey && syncConfig.binId) ? '' : 'none';
  document.getElementById('sync-overlay').classList.add('open');
}

async function manualPull() {
  const btn = document.getElementById('sync-pull-btn');
  btn.disabled = true; btn.textContent = 'Pullingâ€¦';
  await syncPull();
  btn.disabled = false; btn.textContent = 'â†“ Pull latest';
  syncMsg('Board updated from cloud.', 'ok');
}

function closeSyncModal() {
  document.getElementById('sync-overlay').classList.remove('open');
}

function onSyncOverlayClick(e) {
  if (e.target.id === 'sync-overlay') closeSyncModal();
}

function syncMsg(msg, type='') {
  const el = document.getElementById('sync-msg');
  el.textContent = msg;
  el.className = 'sync-msg' + (type ? ' '+type : '');
}

function showBinDisplay(binId) {
  const box = document.getElementById('sync-bin-display');
  if (binId) {
    box.style.display = '';
    document.getElementById('sync-bin-display-val').textContent = binId;
  } else {
    box.style.display = 'none';
  }
}

async function syncConnect() {
  const apiKey = document.getElementById('sync-api-key').value.trim();
  const binId  = document.getElementById('sync-bin-id').value.trim();
  if (!apiKey) { syncMsg('Please enter your Master API Key.', 'err'); return; }

  const btn = document.getElementById('sync-connect-btn');
  btn.disabled = true; btn.textContent = 'Connectingâ€¦';
  syncMsg('');

  try {
    if (binId) {
      // Connect to existing bin â€” pull its data
      const res = await fetch(`${JSONBIN}/b/${binId}/latest`, {
        headers: { 'X-Master-Key': apiKey }
      });
      if (!res.ok) throw new Error(`Could not read bin (${res.status}). Check your API key and Bin ID.`);
      const data = await res.json();
      syncConfig = { apiKey, binId };
      saveSyncConfig();
      mergeCloudState(data.record);
      localStorage.setItem('kanban_v2', JSON.stringify(state));
      render();
      syncMsg('Connected! Board loaded from cloud.', 'ok');
      showBinDisplay(binId);
      updateSyncDot('synced');
      setTimeout(() => updateSyncDot('idle'), 2000);
    } else {
      // Create a new bin with current data
      const res = await fetch(`${JSONBIN}/b`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': apiKey,
          'X-Bin-Name': 'kanban-board',
          'X-Bin-Private': 'true'
        },
        body: JSON.stringify(stateForCloud())
      });
      if (!res.ok) throw new Error(`Could not create bin (${res.status}). Check your API key.`);
      const data = await res.json();
      const newBinId = data.metadata.id;
      syncConfig = { apiKey, binId: newBinId };
      saveSyncConfig();
      document.getElementById('sync-bin-id').value = newBinId;
      syncMsg('Bin created! Copy the Bin ID below and paste it on your other devices.', 'ok');
      showBinDisplay(newBinId);
      updateSyncDot('synced');
      setTimeout(() => updateSyncDot('idle'), 2000);
    }
  } catch(e) {
    syncMsg(e.message || 'Connection failed. Check your credentials.', 'err');
    updateSyncDot('error');
  } finally {
    btn.disabled = false; btn.textContent = 'Connect';
  }
}

/* â”€â”€â”€ Supabase Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function supEnabled() { return !!(storageConfig.url && storageConfig.anonKey); }

function loadStorageConfig() {
  try { storageConfig = JSON.parse(localStorage.getItem('kanban_storage')||'{}') || {}; } catch {}
  storageConfig.url     = storageConfig.url     || '';
  storageConfig.anonKey = storageConfig.anonKey || '';
  updateStorageDot(supEnabled());
}

function saveStorageConfigData() {
  localStorage.setItem('kanban_storage', JSON.stringify(storageConfig));
}

function dataUrlToBlob(dataUrl) {
  const [header, data] = dataUrl.split(',');
  const mime   = header.match(/:(.*?);/)[1];
  const binary = atob(data);
  const arr    = new Uint8Array(binary.length);
  for (let i = 0; i < binary.length; i++) arr[i] = binary.charCodeAt(i);
  return new Blob([arr], { type: mime });
}

async function uploadToSupabase(blobOrDataUrl, filename, mimeType, taskId) {
  const blob = (typeof blobOrDataUrl === 'string') ? dataUrlToBlob(blobOrDataUrl) : blobOrDataUrl;
  const path = `${state.activeBoardId}/${taskId}/${uid()}/${filename}`;
  const endpoint = `${storageConfig.url}/storage/v1/object/attachments/${path}`;
  const res = await fetch(endpoint, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${storageConfig.anonKey}`,
      'apikey':        storageConfig.anonKey,
      'Content-Type':  mimeType || 'application/octet-stream',
      'x-upsert': 'true',
    },
    body: blob
  });
  if (!res.ok) {
    const msg = await res.text().catch(() => String(res.status));
    throw new Error(`Storage upload failed (${res.status}): ${msg}`);
  }
  const publicUrl = `${storageConfig.url}/storage/v1/object/public/attachments/${path}`;
  return { publicUrl, storagePath: path };
}

async function deleteFromSupabase(paths) {
  if (!paths.length || !supEnabled()) return;
  try {
    await fetch(`${storageConfig.url}/storage/v1/object/attachments`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${storageConfig.anonKey}`,
        'apikey':        storageConfig.anonKey,
        'Content-Type':  'application/json',
      },
      body: JSON.stringify({ prefixes: paths })
    });
  } catch { /* ignore â€” orphaned files are acceptable */ }
}

function updateStorageDot(connected) {
  const dot = document.getElementById('storage-dot');
  if (dot) dot.className = `sync-dot ${connected ? 'synced' : 'off'}`;
}

/* â”€â”€ Storage modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openStorageModal() {
  document.getElementById('storage-url').value = storageConfig.url     || '';
  document.getElementById('storage-key').value = storageConfig.anonKey || '';
  storageMsg('');
  if (supEnabled()) storageMsg('File storage is connected.', 'ok');
  document.getElementById('storage-overlay').classList.add('open');
}

function closeStorageModal() {
  document.getElementById('storage-overlay').classList.remove('open');
}

function onStorageOverlayClick(e) { if (e.target.id === 'storage-overlay') closeStorageModal(); }

function storageMsg(msg, type='') {
  const el = document.getElementById('storage-msg');
  el.textContent = msg;
  el.className = 'sync-msg' + (type ? ' '+type : '');
}

async function storageConnect() {
  const url = document.getElementById('storage-url').value.trim().replace(/\/$/, '');
  const key = document.getElementById('storage-key').value.trim();
  if (!url || !key) { storageMsg('Please enter both Project URL and anon key.', 'err'); return; }

  const btn = document.getElementById('storage-connect-btn');
  btn.disabled = true; btn.textContent = 'Testingâ€¦';
  storageMsg('');

  try {
    // Test by listing objects in the bucket (works with anon key on public bucket)
    const res = await fetch(`${url}/storage/v1/object/list/attachments`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${key}`, 'apikey': key, 'Content-Type': 'application/json' },
      body: JSON.stringify({ prefix: '', limit: 1 })
    });
    if (!res.ok) throw new Error(`Cannot reach bucket (${res.status}). Check URL, anon key, and that the bucket is named "attachments".`);
    storageConfig = { url, anonKey: key };
    saveStorageConfigData();
    updateStorageDot(true);
    storageMsg('Connected! Files will now sync via Supabase Storage.', 'ok');
  } catch(e) {
    storageMsg(e.message || 'Connection failed.', 'err');
    updateStorageDot(false);
  } finally {
    btn.disabled = false; btn.textContent = 'Connect';
  }
}

/* â”€â”€â”€ Widgets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let widgetsOpen = true;

function toggleWidgets() {
  widgetsOpen = !widgetsOpen;
  document.getElementById('widget-panel').style.display = widgetsOpen ? '' : 'none';
  document.getElementById('widget-toggle-icon').textContent = widgetsOpen ? 'â–²' : 'â–¼';
  localStorage.setItem('kanban_widgets_open', widgetsOpen ? '1' : '0');
}

function wBody(id, html) {
  const el = document.querySelector(`#${id} .widget-body`);
  if (el) el.innerHTML = html;
}

function pctChg(pct) {
  if (pct == null || isNaN(pct)) return '';
  const cls  = pct >= 0 ? 'widget-up' : 'widget-down';
  const sign = pct >= 0 ? '+' : '';
  return `<span class="${cls}">${sign}${pct.toFixed(2)}%</span>`;
}
function priceChg(now, prev) { return pctChg((now - prev) / prev * 100); }

/* Weather â€” ipinfo.io + Open-Meteo (no key, no GPS permission needed) */
const WMO_DESC = {
  0:'Clear',1:'Mainly clear',2:'Partly cloudy',3:'Overcast',
  45:'Foggy',48:'Icy fog',
  51:'Light drizzle',53:'Drizzle',55:'Heavy drizzle',
  61:'Light rain',63:'Rain',65:'Heavy rain',
  71:'Light snow',73:'Snow',75:'Heavy snow',
  77:'Snow grains',80:'Showers',81:'Showers',82:'Heavy showers',
  85:'Snow showers',86:'Heavy snow showers',
  95:'Thunderstorm',96:'Thunderstorm+hail',99:'Thunderstorm+hail',
};
async function fetchWeather() {
  try {
    // IP-based location â€” works on all devices without permission prompts
    const info = await fetch('https://ipinfo.io/json').then(r => r.json());
    if (!info.loc) throw new Error('no location');
    const [lat, lon] = info.loc.split(',').map(Number);
    const city = info.city || '';
    // Weather from Open-Meteo
    const wx = await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
      `&current=temperature_2m,apparent_temperature,weathercode,windspeed_10m,relativehumidity_2m`
    ).then(r => r.json());
    const c = wx.current;
    const desc = WMO_DESC[c.weathercode] || '';
    wBody('w-weather', `
      <div style="font-size:.85rem;font-weight:700;color:var(--text)">${Math.round(c.temperature_2m)}Â°C
        <span style="font-size:.7rem;font-weight:400;color:var(--muted)">${desc}</span>
      </div>
      <div class="widget-muted" style="margin-top:2px">Feels ${Math.round(c.apparent_temperature)}Â°C${city ? ' Â· ' + city : ''}</div>
      <div class="widget-row" style="margin-top:4px">
        <span>ğŸ’§ ${c.relativehumidity_2m}%</span>
        <span>ğŸ’¨ ${Math.round(c.windspeed_10m)} km/h</span>
      </div>`);
  } catch { wBody('w-weather', '<span class="widget-muted">Unavailable</span>'); }
}

/* Exchange rates â€” frankfurter.app (no key needed) */
async function fetchFX() {
  try {
    const d = await fetch('https://api.frankfurter.app/latest?from=GBP&to=USD,EUR,TRY').then(r => r.json());
    const r = d.rates;
    wBody('w-fx', `
      <div class="widget-row"><span>USD</span><span class="widget-val">${r.USD?.toFixed(4) ?? 'â€”'}</span></div>
      <div class="widget-row"><span>EUR</span><span class="widget-val">${r.EUR?.toFixed(4) ?? 'â€”'}</span></div>
      <div class="widget-row"><span>TRY</span><span class="widget-val">${r.TRY?.toFixed(2) ?? 'â€”'}</span></div>`);
  } catch { wBody('w-fx', '<span class="widget-muted">Unavailable</span>'); }
}

/* Markets â€” Yahoo Finance with dual CORS proxy fallback */
async function yhFetch(sym) {
  const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(sym)}?interval=1d&range=5d`;
  // Try corsproxy.io first (returns raw JSON)
  try {
    const d = await fetch(`https://corsproxy.io/?url=${encodeURIComponent(url)}`,
      { signal: AbortSignal.timeout(6000) }).then(r => r.json());
    if (d?.chart?.result?.length) return d;
  } catch {}
  // Fallback to allorigins (wraps response in {contents:"..."})
  const d = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
    { signal: AbortSignal.timeout(6000) }).then(r => r.json());
  return JSON.parse(d.contents);
}

async function fetchStocks() {
  const syms = [
    { sym: '^FTSE', label: 'FTSE 100' },
    { sym: '^GSPC', label: 'S&P 500'  },
    { sym: 'NVDA',  label: 'NVIDIA'   },
  ];
  wBody('w-stocks', syms.map(s =>
    `<div class="widget-row" id="mkt-${s.sym.replace('^','')}"><span>${s.label}</span><span class="widget-muted">â€¦</span></div>`
  ).join(''));

  for (let i = 0; i < syms.length; i++) {
    if (i > 0) await new Promise(r => setTimeout(r, 800));
    const s   = syms[i];
    const row = document.getElementById(`mkt-${s.sym.replace('^','')}`);
    if (!row) continue;
    try {
      const data   = await yhFetch(s.sym);
      const result = data?.chart?.result;
      if (!result?.length) throw new Error('no data');
      const closes = result[0].indicators.quote[0].close.filter(v => v != null);
      const cur    = closes[closes.length - 1];
      const prev   = closes[closes.length - 2];
      const fmt    = cur >= 1000 ? cur.toLocaleString(undefined, { maximumFractionDigits: 0 }) : cur.toFixed(2);
      row.innerHTML = `<span>${s.label}</span><span class="widget-val">${fmt} ${priceChg(cur, prev)}</span>`;
    } catch {
      row.innerHTML = `<span>${s.label}</span><span class="widget-muted">â€”</span>`;
    }
  }
}

function loadAlphaKey() {} // no-op, kept for boot compat

/* Crypto â€” Kraken (free, no key, CORS enabled) */
async function fetchCrypto() {
  const fmt = n => n >= 1000 ? n.toLocaleString(undefined, { maximumFractionDigits: 0 }) : n.toFixed(2);
  const fetchPair = async (pair, label) => {
    try {
      const d = await fetch(`https://api.kraken.com/0/public/Ticker?pair=${pair}`).then(r => r.json());
      if (d.error?.length) return `<div class="widget-row"><span>${label}</span><span class="widget-muted">â€”</span></div>`;
      const t = Object.values(d.result)[0];
      const p = parseFloat(t.c[0]), o = parseFloat(t.o);
      return `<div class="widget-row"><span>${label}</span><span class="widget-val">Â£${fmt(p)} ${priceChg(p, o)}</span></div>`;
    } catch { return `<div class="widget-row"><span>${label}</span><span class="widget-muted">â€”</span></div>`; }
  };
  const rows = await Promise.all([
    fetchPair('XXBTZGBP', 'BTC'),
    fetchPair('XETHZGBP', 'ETH'),
    fetchPair('SOLGBP',   'SOL'),
  ]);
  wBody('w-crypto', rows.join(''));
}

/* World clocks */
const WORLD_CLOCKS = [
  { label: 'London',   tz: 'Europe/London'   },
  { label: 'New York', tz: 'America/New_York' },
  { label: 'Istanbul', tz: 'Europe/Istanbul'  },
  { label: 'Dubai',    tz: 'Asia/Dubai'       },
];
function updateClocks() {
  const now  = new Date();
  const html = WORLD_CLOCKS.map(c => {
    const t = now.toLocaleTimeString('en-GB', { timeZone: c.tz, hour: '2-digit', minute: '2-digit' });
    return `<div class="widget-row"><span>${c.label}</span><span class="widget-val">${t}</span></div>`;
  }).join('');
  wBody('w-clocks', html);
}

function openWidgetSheet() {
  // Copy current widget content into the sheet
  const ids = ['w-weather','w-fx','w-stocks','w-clocks','w-crypto'];
  const body = document.getElementById('widget-sheet-body');
  body.innerHTML = ids.map(id => {
    const card = document.getElementById(id);
    return card ? card.outerHTML : '';
  }).join('');
  document.getElementById('widget-sheet').classList.add('open');
  document.getElementById('widget-sheet-overlay').classList.add('open');
}

function closeWidgetSheet() {
  document.getElementById('widget-sheet').classList.remove('open');
  document.getElementById('widget-sheet-overlay').classList.remove('open');
}

function initWidgets() {
  loadAlphaKey();
  widgetsOpen = localStorage.getItem('kanban_widgets_open') !== '0';
  if (!widgetsOpen) {
    document.getElementById('widget-panel').style.display = 'none';
    document.getElementById('widget-toggle-icon').textContent = 'â–¼';
  }
  fetchWeather();
  fetchFX();
  fetchStocks();
  fetchCrypto();
  updateClocks();
  setInterval(fetchWeather,  10 * 60 * 1000); // 10 min
  setInterval(fetchFX,       60 * 60 * 1000); // 1 hour
  setInterval(fetchStocks,   10 * 60 * 1000); // 10 min
  setInterval(fetchCrypto,    5 * 60 * 1000); // 5 min
  setInterval(updateClocks,           1000);  // 1 sec
}

/* â”€â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => navigator.serviceWorker.register('/kanban/sw.js'));
}

load();
loadSyncConfig();
loadStorageConfig();
loadSortMode();
render();
syncPull();
initWidgets();
</script>
</body>
</html>
